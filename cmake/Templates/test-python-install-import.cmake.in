cmake_policy(SET CMP0010 NEW)
set(DEFAULT_PYTHONPATH "$ENV{PYTHONPATH}")
set(INSTALL_PYTHONPATH "@INSTALL_PYTHONDIR@")
if(NOT IS_ABSOLUTE "${INSTALL_PYTHONPATH}")
    set(INSTALL_PYTHONPATH "@CMAKE_INSTALL_PREFIX@/${INSTALL_PYTHONPATH}")
endif()
get_filename_component(INSTALL_PYTHONPATH "${INSTALL_PYTHONPATH}" DIRECTORY)

set(LIBPATH "@CMAKE_INSTALL_PREFIX@/@CMAKE_INSTALL_LIBDIR@")

set(ENV{TIMEMORY_BANNER} "OFF")
set(ENV{PYTHONPATH} "${INSTALL_PYTHONPATH}:${DEFAULT_PYTHONPATH}")
message(STATUS "PYTHONPATH: $ENV{PYTHONPATH}")

if(APPLE)
    set(ENV{DYLD_LIBRARY_PATH} "${LIBPATH}:$ENV{DYLD_LIBRARY_PATH}")
    message(STATUS "DYLD_LIBRARY_PATH: $ENV{DYLD_LIBRARY_PATH}")
elseif(UNIX)
    message(STATUS "LD_LIBRARY_PATH: $ENV{LD_LIBRARY_PATH}")
endif()

execute_process(
    COMMAND @PYTHON_EXECUTABLE@ -c
            "import timemory; print('{}'.format(timemory.__file__))"
    WORKING_DIRECTORY @PROJECT_BINARY_DIR@/tests
    OUTPUT_VARIABLE OUT_MSG
    ERROR_VARIABLE ERR_MSG
    RESULT_VARIABLE ERR_CODE
    OUTPUT_STRIP_TRAILING_WHITESPACE ERROR_STRIP_TRAILING_WHITESPACE)

if(ERR_CODE)
    message(FATAL_ERROR "Error! Exit code: ${ERR_CODE}. ${ERR_MSG}")
else()
    message(STATUS "Success! Exit code: ${ERR_CODE}. ${OUT_MSG}")
endif()
